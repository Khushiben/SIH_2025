<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Choose Distributor - AgriDirect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: #f8f9fa; display:flex; flex-direction:column; }
    main { flex:1; padding:20px; }
    h1 { text-align:center; margin:30px 0; color:#2d6a4f; font-weight:bold; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    th, td { padding:12px 15px; text-align:left; border-bottom:1px solid #ddd; }
    th { background-color:#5D8736; color:#fff; font-weight:600; }
    tr:hover { background-color:#eaf4e0; }
    nav { display:flex; justify-content:space-between; align-items:center; background:#5D8736; padding:15px 30px; font-size:larger; }
    .logo { display:flex; align-items:center; }
    .logo video { width:50px; height:50px; margin-right:10px; border-radius:5px; }
    .logo-text { font-size:24px; font-weight:bold; color:#ffffff; }
    nav ul { list-style:none; display:flex; }
    nav ul li { margin:0 15px; padding:7px; }
    nav ul li a { text-decoration:none; color:#ffffff; font-weight:bold; }
    nav ul li a:hover { color:#F4FFC3; }
    footer { background:white; color:#809D3C; padding:30px 20px; text-align:center; border-top:2px solid #5D8736; }
   /* Hide Google logo and branding in the translate widget */
        #google_translate_element .goog-logo-link,
        #google_translate_element .goog-te-gadget span {
          display: none !important;
        }

        /* Remove extra margin/padding from the widget */
        #google_translate_element {
          margin: 0 !important;
          padding: 5px !important;
          min-width: 120px;
          max-width: 180px;
          font-size: 0.95em;
        }

        /* Make dropdown blend with navbar */
        .goog-te-combo {
          border-radius: 6px !important;
          border: 1.5px solid #e2c106 !important;
          padding: 6px 12px !important;
          background: #fff !important;
          color: #2d6a4f !important;
          font-weight: 500 !important;
          font-family: inherit !important;
          outline: none !important;
          transition: border-color 0.3s;
        }
        .goog-te-combo:focus {
          border-color: #5D8736 !important;
        }

        /* Prevent widget from overlapping content */
        body #google_translate_element {
          z-index: 10;
          position: relative;
        }
        </style>

</head>

<body>

<header>
  <nav>
    <div class="logo">
      <video autoplay loop muted>
        <source src="image/agridirect.mp4" type="video/mp4">
      </video>
      <span class="logo-text">AgriDirect</span>
    </div>
    <ul>
      <li><a href="shared_homepage.html">HOME</a></li>
      <li><a href="marketplace.html">MARKETPLACE</a></li>
      <li><a id="dashboardLink" href="#">DASHBOARD</a></li>
      <li><a href="about_us.html">ABOUT US</a></li>
      <li><a id="authLink" href="role.html">LOGIN/SIGN UP</a></li>
     <li>
          <div id="google_translate_element" style="display:inline-block; vertical-align:middle;"></div>
        </li></ul>
  </nav>
</header>
<script>function googleTranslateElementInit() {
        new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
      }</script>
      <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<main>
  <h1>Choose a Distributor</h1>
  <div class="table-responsive">
    <table id="distributorTable" class="table table-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Location</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<footer>
  <p>&copy; 2025 AgriDirect. All Rights Reserved.</p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  // ----------------------- SESSION & DASHBOARD -----------------------
  const dashboardLink = document.getElementById("dashboardLink");
  const authLink = document.getElementById("authLink");
  const userRole = localStorage.getItem("userRole");

  if (!userRole || userRole !== "farmer") {
    // Only farmers can access this page
    alert("Access denied. Please login as a farmer.");
    window.location.href = "role.html";
    return;
  }

  dashboardLink.href = "marketplacefarmer.html";
  authLink.textContent = "LOGOUT";
  authLink.href = "#";
  authLink.onclick = () => {
    localStorage.clear();
    window.location.href = "shared_homepage.html";
  };

  // ----------------------- FETCH DISTRIBUTORS -----------------------
  const tbody = document.querySelector("#distributorTable tbody");
  let distributors = [];

  try {
    const res = await fetch("http://localhost:5000/distributors");
    const data = await res.json();
    distributors = data.distributors || [];

    if (!distributors.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center">No distributors available</td></tr>`;
      return;
    }

    const formatLocation = (loc) => {
      if (!loc) return "N/A";
      if (typeof loc === "string") return loc;

      // Common keys we might receive
      const fields = [
        "location","address","name","label","city","state","district",
        "village","town","formatted","description","country","pincode","zip"
      ];
      for (const key of fields) {
        if (loc[key]) return loc[key];
      }

      // Fallback: try to use first stringish value
      const firstString = Object.values(loc).find(v => typeof v === "string" && v.trim());
      return firstString || "N/A";
    };

    tbody.innerHTML = ""; // clear any previous content
    distributors.forEach((d, i) => {
      const locationText = formatLocation(d.location);
      const phoneText = d.mobile || d.phone || "N/A";
      tbody.innerHTML += `
        <tr>
          <td>${d.name}</td>
          <td>${locationText}</td>
          <td>${d.email}</td>
          <td>${phoneText}</td>
          <td><button class="btn btn-success btn-sm choose-btn" data-id="${i}">Choose</button></td>
        </tr>
      `;
    });

  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="5" class="text-center">Error loading distributors</td></tr>`;
  }

  // ----------------------- CHOOSE BUTTON -----------------------
  tbody.addEventListener("click", (e) => {
    if (!e.target.classList.contains("choose-btn")) return;

    const index = e.target.getAttribute("data-id");
    const selected = distributors[index];

    const productId = localStorage.getItem("selectedProductId");
    const farmerId = localStorage.getItem("selectedProductOwnerFarmerId");


    if (!farmerId) {
        alert("Please login first!");
        window.location.href = "role.html";
        return;
    }

    if (!productId) {
        alert("No product selected. Please select a product first.");
        window.location.href = "marketplacefarmer.html";
        return;
    }

    try {
        // Save selection
        localStorage.setItem("selectedDistributorId", selected._id || selected.id);
        localStorage.setItem("selectedDistributorName", selected.name);

        // Save the pending product request for distributor
const requestPayload = {
    farmerId,
    distributorId: selected._id || selected.id,
    productId
};

fetch("http://localhost:5000/distributor/newRequest", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(requestPayload)
})
.then(res => res.json())
.then(data => {
    alert(`✅ Distributor "${selected.name}" selected successfully!`);
    window.location.href = "marketplace.html";
})
.catch(err => {
    console.error(err);
    alert("Error sending request to distributor");
});


    } catch (err) {
        console.error(err);
        alert("❌ Something went wrong. Please try again later.");
    }
});


});
</script>

</body>
</html>
