<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distributor Marketplace - AgriDirect</title>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f8f9fa; margin:0; }

    /* NAVBAR */
    nav { 
      display:flex; justify-content:space-between; align-items:center; 
      background:#5D8736; padding:15px 30px; position:sticky; top:0; z-index:1000;
    }
    .logo { display:flex; align-items:center; }
    .logo video { width:50px; height:50px; border-radius:5px; margin-right:10px; }
    .logo-text { color:white; font-size:24px; font-weight:bold; }
    nav ul { list-style:none; display:flex; gap:20px; margin:0; padding:0; }
    nav ul li a { color:white; text-decoration:none; font-weight:bold; }
    nav ul li a:hover { color:#F4FFC3; }

    /* PRODUCT GRID */
    .container { padding:30px; max-width:1400px; margin:auto; }
    h2 { text-align:center; color:#2d6a4f; margin-bottom:20px; }

    .product-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
      gap:20px;
    }

    /* CARD STYLING (same as farmer marketplace) */
    .card-container { perspective:1000px; }

    .product-card {
      width:100%; height:560px; background:white;
      border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);
      position:relative; transform-style:preserve-3d;
      transition:transform 0.8s;
    }
    .product-card:hover { transform:scale(1.02); }

    .product-card.is-flipped { transform:rotateY(180deg); }

    .card-side {
      position:absolute; width:100%; height:100%; backface-visibility:hidden;
      border-radius:12px; padding:15px; box-sizing:border-box; background:white;
    }

    .card-front img {
      width:100%; height:200px; object-fit:cover; border-radius:8px;
    }

    .card-back { transform:rotateY(180deg); text-align:center; }

    .price { color:#d00000; font-size:18px; font-weight:bold; }

    .btn-order {
      padding:10px; border:none; width:49%; background:#2d6a4f; color:white;
      border-radius:8px; cursor:pointer; transition:0.3s;
    }
    .btn-order:hover { background:#1b4332; }

    .btn-qr {
      padding:10px; border:none; width:49%; background:#e2c106; color:white;
      border-radius:8px; cursor:pointer;
    }
    .btn-qr:hover { background:#ec8404; }

    .btn-back {
      margin-top:10px; padding:8px 12px; border:2px solid #2d6a4f;
      background:white; color:#2d6a4f; border-radius:8px; cursor:pointer;
    }

    .qr-box { width:150px; height:150px; margin:auto; }

    /* FOOTER */
    footer {
      margin-top: 30px; background:white; color:#809D3C; padding:30px 20px;
      text-align:center; border-top:2px solid #5D8736;
    }
    .footer-container {
      display:flex; justify-content:space-between; flex-wrap:wrap;
      max-width:1200px; margin:auto;
    }
    .footer-logo { display:flex; align-items:center; font-size:22px; font-weight:bold; }
    .footer-logo video { width:50px; height:50px; margin-right:10px; border-radius:5px; }
    .footer-social a img { width:30px; margin:0 10px; transition:0.3s; }
    .footer-social a img:hover { transform:scale(1.2); }
   /* Hide Google logo and branding in the translate widget */
        #google_translate_element .goog-logo-link,
        #google_translate_element .goog-te-gadget span {
          display: none !important;
        }

        /* Remove extra margin/padding from the widget */
        #google_translate_element {
          margin: 0 !important;
          padding: 5px !important;
          min-width: 120px;
          max-width: 180px;
          font-size: 0.95em;
        }

        /* Make dropdown blend with navbar */
        .goog-te-combo {
          border-radius: 6px !important;
          border: 1.5px solid #e2c106 !important;
          padding: 6px 12px !important;
          background: #fff !important;
          color: #2d6a4f !important;
          font-weight: 500 !important;
          font-family: inherit !important;
          outline: none !important;
          transition: border-color 0.3s;
        }
        .goog-te-combo:focus {
          border-color: #5D8736 !important;
        }

        /* Prevent widget from overlapping content */
        body #google_translate_element {
          z-index: 10;
          position: relative;
        }</style>
</head>

<body>

<!-- NAVBAR -->
<nav>
  <div class="logo">
    <video autoplay loop muted>
      <source src="image/agridirect.mp4" type="video/mp4">
    </video>
    <span class="logo-text">AgriDirect</span>
  </div>

  <ul>
    <li><a href="shared_homepage.html">HOME</a></li>
    <li><a href="marketplace.html">MARKETPLACE</a></li>
    <li><a id="dashboardLink" href="#">DASHBOARD</a></li>
    <li><a href="about_us.html">ABOUT US</a></li>
    <li><a id="authLink" href="role.html">LOGIN/SIGN UP</a></li>
   <li>
          <div id="google_translate_element" style="display:inline-block; vertical-align:middle;"></div>
        </li></ul>
</nav>
<script>function googleTranslateElementInit() {
        new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
      }</script>
      <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<div class="container">
  <h2>Distributor Stock Marketplace</h2>
  <div class="product-grid" id="productGrid"></div>
</div>

<!-- FOOTER -->
<footer>
  <div class="footer-container">
    <div class="footer-logo">
      <video autoplay loop muted>
        <source src="image/logo.mp4" type="video/mp4">
      </video>
      <span>AgriDirect</span>
    </div>

    <div class="footer-contact">
      <h3>Contact Us</h3>
      <p>Email: support@agriDirect.com</p>
      <p>Phone: +91 10101 01010</p>
    </div>

    <div class="footer-social">
      <h3>Follow Us</h3>
      <a href="#"><img src="image/linkedin.png"></a>
      <a href="#"><img src="image/twitter.png"></a>
      <a href="#"><img src="image/instagram.png"></a>
      <a href="#"><img src="image/youtube.png"></a>
    </div>
  </div>
  <p>&copy; 2025 AgriDirect. All Rights Reserved.</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ðŸ”¹ LOAD DISTRIBUTOR STOCK */
async function loadMarketplaceProducts() {
  try {
    const res = await fetch("http://localhost:5000/marketplace/all");
    const data = await res.json();

    const grid = document.getElementById("productGrid");
    grid.innerHTML = "";

    if (!data.success || data.products.length === 0) {
      grid.innerHTML = "<center><h3 style='text-align:center;color:#666;'>No Marketplace Products Available</h3></center>";
      return;
    }

    data.products.forEach(p => {
      const card = document.createElement("div");
      card.className = "card-container";

card.innerHTML = `
  <div class="product-card">
    <div class="card-side card-front">
      <img src="http://localhost:5000/uploads/${p.image}" alt="">

      <h3>${p.productName}</h3>
      <p><b>Type:</b> ${p.productType}</p>
      <p><b>Bought Date:</b> ${p.boughtDate}</p>
      <p><b>Stored Days:</b> ${p.storedDays}</p>
      <p><b>Cold Storage:</b> ${p.coldStorage}</p>
      <p><b>Processing:</b> ${p.processingStatus || "Not Provided"}</p>

      <!-- ðŸ”¹ DYNAMIC FIELDS BASED ON PRODUCT TYPE -->
      ${p.productType === "grain" ? `
        <p><b>Grade:</b> ${p.grade || "N/A"}</p>
        <p><b>Moisture %:</b> ${p.moisturePercentage || "N/A"}</p>
        <p><b>Impurity %:</b> ${p.impurityPercentage || "N/A"}</p>
      ` : ""}

      ${p.productType === "fruit" ? `
        <p><b>Ripeness:</b> ${p.ripenessLevel || "N/A"}</p>
        <p><b>Color Grade:</b> ${p.colorGrade || "N/A"}</p>
        <p><b>Damage %:</b> ${p.damagePercentage || "N/A"}</p>
      ` : ""}

      ${p.productType === "vegetable" ? `
        <p><b>Freshness Score:</b> ${p.freshnessScore || "N/A"}</p>
        <p><b>Washed:</b> ${p.isWashed || "N/A"}</p>
        <p><b>Preservation:</b> ${p.preservationMethod || "N/A"}</p>
      ` : ""}

      <p class="price">â‚¹${p.marketPrice}</p>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn-order" onclick="buyNow('${encodeURIComponent(JSON.stringify(p))}')">Buy Now</button>
        <button class="btn-qr" onclick="flipCard(this)">More Info</button>
      </div>
    </div>

    <div class="card-side card-back">
      <h3>Distributor Details</h3>
      <p><b>ID:</b> ${p.distributorId}</p>
      <p><b>Name:</b> ${p.distributorName || "Not Provided"}</p>
      <p><b>Batch:</b> ${p.batchId || "Not Provided"}</p>

      <p><b>Added On:</b> ${new Date(p.createdAt).toLocaleString()}</p>

      <button class="btn-back" onclick="unflipCard(this)">Back</button>
    </div>
  </div>
`;



      card.querySelector(".product-card").addEventListener("click", function(e){
        if (!e.target.closest("button")) this.classList.toggle("is-flipped");
      });

      grid.appendChild(card);
    });

  } catch (err) {
    console.log(err);
    alert("Failed to load marketplace products.");
  }
}

loadMarketplaceProducts();

/* ðŸ”¹ ORDER FROM DISTRIBUTOR */
async function orderDistributor(productId, price) {
  const retailerId = localStorage.getItem("retailerId");
  if (!retailerId) return alert("Login as Retailer first!");

  const body = { productId, retailerId, price };

  const res = await fetch("http://localhost:5000/retailer/order", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });

  const data = await res.json();
  alert(data.message);
}

/* ðŸ”¹ QR LOGIC */
function showQR(btn, encoded) {
  const product = JSON.parse(decodeURIComponent(encoded));
  const card = btn.closest(".product-card");
  card.classList.add("is-flipped");

  setTimeout(() => {
    const box = card.querySelector(".qr-box");
    box.innerHTML = "";

    if (product.qrPath) {
      const img = document.createElement("img");
      img.src = `http://localhost:5000${product.qrPath}`;
      img.style.width = "150px";
      img.style.height = "150px";
      box.appendChild(img);
    } else {
      box.innerHTML = "<p>No QR found</p>";
    }
  }, 400);
}
function unflipCard(btn) {
  btn.closest(".product-card").classList.remove("is-flipped");
}

/* ðŸ”¹ NAVBAR LOGIN/LOGOUT LOGIC */
document.addEventListener("DOMContentLoaded", () => {
  const dashboardLink = document.getElementById("dashboardLink");
  const authLink = document.getElementById("authLink");
  const role = localStorage.getItem("userRole");

  if (role === "retailer") dashboardLink.href = "retailer_dashboard.html";
  else dashboardLink.href = "role.html";

  if (role) {
    authLink.textContent = "LOGOUT";
    authLink.href = "#";
    authLink.onclick = () => {
      localStorage.clear();
      window.location.href = "shared_homepage.html";
    };
  }
});
function flipCard(btn) {
  btn.closest(".product-card").classList.add("is-flipped");
}

function unflipCard(btn) {
  btn.closest(".product-card").classList.remove("is-flipped");
}

function buyNow(encodedProduct) {
  const product = JSON.parse(decodeURIComponent(encodedProduct));

  const query = new URLSearchParams({
    id: product._id,
    name: product.productName || "",      // <-- FIXED
    price: product.marketPrice,
    image: product.image,
    distributorId: product.distributorId,
    distributorName: product.distributorName || ""
  }).toString();

  window.location.href = `retailer_checkout.html?${query}`;
}


</script>

</body>
</html>
